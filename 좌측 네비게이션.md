# 좌측 네비게이션 (LNB) 구조

## 핵심 원칙

```
menu.code === permission.code === routeMap 키
```

이 3개가 **반드시 동일**해야 시스템이 정상 작동합니다.

---

## 현재 메뉴 그룹 구조 (수정 완료)

```
DASHBOARD               → 대시보드

PATIENT (그룹)
├── PATIENT_LIST        → 환자 목록
├── PATIENT_DETAIL      → 환자 상세 (breadcrumb_only)
└── PATIENT_CARE        → 환자 진료

ORDER (그룹) - 오더 관리
├── ORDER_LIST          → 검사 현황 (간호사/관리자용 - 전체 조회)
├── ORDER_CREATE        → 오더 생성 (breadcrumb_only)
└── OCS_ORDER           → 내 검사 오더 (의사용 - 본인 오더만)

IMAGING (그룹) - 영상 관련
├── IMAGE_VIEWER        → 영상 조회
├── RIS_WORKLIST        → RIS 판독 Worklist
├── OCS_RIS             → 영상 워크리스트 (RIS용)
├── OCS_RIS_DETAIL      → 영상 상세 (breadcrumb_only)
└── RIS_DASHBOARD       → 판독 현황 대시보드

LAB (그룹) - 검사 관련
├── LAB_RESULT_VIEW     → 검사 조회
├── LAB_RESULT_UPLOAD   → 검사 결과 업로드 (breadcrumb_only, OCS에서 이동)
├── OCS_LIS             → 검사 워크리스트 (LIS용)
├── OCS_LIS_DETAIL      → 검사 상세 (breadcrumb_only)
└── LIS_PROCESS_STATUS  → 결과 처리 상태

AI_SUMMARY              → AI 분석 요약

NURSE_RECEPTION         → 진료 접수 현황 (간호사 전용)

ADMIN (그룹)
├── ADMIN_USER          → 사용자 관리
├── ADMIN_USER_DETAIL   → 사용자 상세 (breadcrumb_only)
├── ADMIN_ROLE          → 역할 관리
├── ADMIN_MENU_PERMISSION → 메뉴 권한 관리
├── ADMIN_AUDIT_LOG     → 감사 로그
└── ADMIN_SYSTEM_MONITOR → 시스템 모니터링
```

---

## 기존 DB 마이그레이션

이미 DB에 데이터가 있는 경우, 아래 쿼리로 그룹을 재배치하세요:

```sql
-- OCS_RIS, RIS_DASHBOARD → IMAGING 그룹 (parent_id=4)
UPDATE menus_menu SET parent_id = 4 WHERE code = 'OCS_RIS';
UPDATE menus_menu SET parent_id = 4 WHERE code = 'RIS_DASHBOARD';

-- OCS_LIS, LIS_PROCESS_STATUS → LAB 그룹 (parent_id=5)
UPDATE menus_menu SET parent_id = 5 WHERE code = 'OCS_LIS';
UPDATE menus_menu SET parent_id = 5 WHERE code = 'LIS_PROCESS_STATUS';
```

---

## 구성 요소

| 구성요소 | 역할 | 위치 |
|----------|------|------|
| `menus_menu` | 사이드바 UI 트리 구조 | DB |
| `accounts_permission` | 접근 권한 제어 | DB |
| `routeMap` | code → React 컴포넌트 연결 | Frontend |

---

## 메뉴 유형

| 유형 | 조건 | 용도 | 예시 |
|------|------|------|------|
| **그룹 메뉴** | `path = NULL` | 펼침/접힘 부모 메뉴 | PATIENT, ADMIN |
| **화면 메뉴** | `path 있음`, `breadcrumb_only = 0` | 사이드바 표시 & 클릭 이동 | DASHBOARD, PATIENT_LIST |
| **숨김 메뉴** | `breadcrumb_only = 1` | 사이드바 미표시 (상세 페이지용) | PATIENT_DETAIL |

---

## 데이터 흐름

```
[DB]                              [Frontend]
menus_menu (트리) ────┐
                      ├──▶ 로그인 시 전달 ──▶ AuthProvider 보관
accounts_permission ──┘                              │
                                          ┌─────────┴─────────┐
                                          ▼                   ▼
                                      Sidebar            AppRoutes
                                    (UI 렌더링)         (라우트 생성)
                                          └─────────┬─────────┘
                                                    ▼
                                               routeMap
                                          (code → Component)
```

---

## 새 메뉴 추가 절차

### Step 1: DB 작업

```sql
-- 1. menus_menu에 메뉴 추가
INSERT INTO menus_menu (code, path, icon, parent_id, breadcrumb_only, `order`, is_active)
VALUES ('NEW_MENU', '/new-path', 'icon-name', {parent_id}, 0, 1, 1);

-- 2. accounts_permission에 권한 추가 (code 동일!)
INSERT INTO accounts_permission (code, name, description)
VALUES ('NEW_MENU', '새 메뉴', '새 메뉴 설명');

-- 3. menus_menupermission 연결
INSERT INTO menus_menupermission (menu_id, permission_id)
SELECT m.id, p.id FROM menus_menu m
JOIN accounts_permission p ON m.code = p.code
WHERE m.code = 'NEW_MENU';

-- 4. 역할에 권한 부여
INSERT INTO accounts_role_permissions (role_id, permission_id)
SELECT r.id, p.id FROM accounts_role r
JOIN accounts_permission p ON p.code = 'NEW_MENU'
WHERE r.code IN ('SYSTEMMANAGER', 'ADMIN');

-- 5. 메뉴 라벨 추가
INSERT INTO menus_menulabel (role, text, menu_id)
VALUES ('DEFAULT', '새 메뉴', {menu_id});
```

### Step 2: Frontend 작업

```tsx
// 1. 페이지 컴포넌트 생성
// src/pages/new/NewMenuPage.tsx

// 2. routeMap에 등록
// src/router/routeMap.tsx
import NewMenuPage from '@/pages/new/NewMenuPage';

export const routeMap: Record<string, ComponentType> = {
  // ... 기존 메뉴들
  NEW_MENU: NewMenuPage,
};
```

---

## 메뉴 삭제 절차

```sql
-- FK 제약조건 때문에 역순으로 삭제

-- 1. ROLE ↔ PERMISSION 연결 삭제
DELETE rp FROM accounts_role_permissions rp
JOIN accounts_permission p ON p.id = rp.permission_id
WHERE p.code = 'TARGET_MENU';

-- 2. MENU ↔ PERMISSION 연결 삭제
DELETE mp FROM menus_menupermission mp
JOIN menus_menu m ON m.id = mp.menu_id
WHERE m.code = 'TARGET_MENU';

-- 3. 메뉴 라벨 삭제
DELETE ml FROM menus_menulabel ml
JOIN menus_menu m ON m.id = ml.menu_id
WHERE m.code = 'TARGET_MENU';

-- 4. PERMISSION 삭제
DELETE FROM accounts_permission WHERE code = 'TARGET_MENU';

-- 5. MENU 삭제
DELETE FROM menus_menu WHERE code = 'TARGET_MENU';
```

---

## 역할별 권한

| 역할 | 접근 가능 메뉴 |
|------|---------------|
| **SYSTEMMANAGER** | 모든 메뉴 |
| **ADMIN** | 대시보드, 환자, 오더, 영상, 검사, AI, 관리자(시스템 모니터링 제외) |
| **DOCTOR** | 대시보드, 환자 목록/상세, 오더 목록, 영상 뷰어, RIS Worklist |
| **NURSE** | 대시보드, 환자 목록/상세, 오더 목록, 영상 뷰어, 검사 결과 조회 |
| **RIS** | 대시보드, 영상 뷰어, RIS Worklist |
| **LIS** | 대시보드, 검사 결과 조회/업로드 |

---

## 검증 쿼리

```sql
-- menu.code와 permission.code 불일치 확인 (0건이어야 정상)
SELECT m.code AS menu_code, p.code AS permission_code
FROM menus_menu m
JOIN menus_menupermission mp ON mp.menu_id = m.id
JOIN accounts_permission p ON p.id = mp.permission_id
WHERE m.code != p.code;

-- 역할별 권한 수 확인
SELECT r.code, COUNT(*) AS permission_count
FROM accounts_role_permissions rp
JOIN accounts_role r ON r.id = rp.role_id
GROUP BY r.code;
```

---

## 주의사항

1. **code 일치 필수**: `menus_menu.code`, `accounts_permission.code`, `routeMap` 키는 반드시 동일
2. **breadcrumb_only 메뉴**: 권한은 필요하지만 사이드바에 표시하지 않을 때 사용
3. **그룹 메뉴 권한**: 그룹 메뉴(path=NULL)도 permission이 있어야 하위 메뉴 접근 가능
4. **역할별 라벨**: DEFAULT 라벨은 필수, 역할별 커스텀 라벨은 선택
5. **라우트 보호**: 모든 화면은 `ProtectedRoute`로 감싸서 인증 체크


menus_menu 테이블 설명
사이드바 UI 트리 구조를 저장하는 테이블입니다.

컬럼 구조
컬럼	설명	예시
id	PK	1, 2, 3...
code	고유 식별자 (routeMap 키와 일치)	DASHBOARD, OCS_RIS
path	URL 경로 (NULL이면 그룹 메뉴)	/dashboard, /ocs/ris
icon	FontAwesome 아이콘명	home, x-ray
group_label	그룹 메뉴 표시 라벨	영상, 검사
parent_id	부모 메뉴 FK (self-reference)	4 (IMAGING의 id)
breadcrumb_only	1이면 사이드바에 미표시	상세 페이지용
order	정렬 순서	1, 2, 3...
is_active	활성화 여부	1 또는 0
메뉴 유형 3가지

1. 그룹 메뉴 (path = NULL)
   → 펼침/접힘 가능한 부모 메뉴
   → 예: PATIENT, ORDER, IMAGING, LAB, ADMIN

2. 화면 메뉴 (path 있음, breadcrumb_only = 0)
   → 사이드바에 표시, 클릭 시 이동
   → 예: DASHBOARD, PATIENT_LIST, OCS_RIS

3. 숨김 메뉴 (breadcrumb_only = 1)
   → 사이드바에 미표시, 다른 화면에서 진입
   → 예: PATIENT_DETAIL, OCS_RIS_DETAIL
현재 구조 예시

-- 그룹 메뉴 (path = NULL)
(4, 'IMAGING', NULL, NULL, '영상', 0, 4, 1, NULL)

-- 화면 메뉴 (IMAGING 그룹 하위)
(14, 'IMAGE_VIEWER', '/imaging', 'image', NULL, 0, 1, 1, 4)
(24, 'OCS_RIS', '/ocs/ris', 'x-ray', NULL, 0, 3, 1, 4)  -- parent_id=4

-- 숨김 메뉴 (OCS_RIS 하위)
(26, 'OCS_RIS_DETAIL', '/ocs/ris/:ocsId', 'x-ray', NULL, 1, 1, 1, 24)  -- breadcrumb_only=1
핵심 포인트

menu.code === permission.code === routeMap 키
이 3개가 일치해야 메뉴가 정상 작동합니다.
