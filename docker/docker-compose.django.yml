# =============================================================
# docker-compose.django.yml - Django Backend + Infrastructure
# =============================================================
# ⚠️ DEPRECATED: 단일 VM 배포 시 docker-compose.unified.yml 사용 권장
#    이 파일은 2-VM 분리 배포 시에만 사용
#    Use docker-compose.unified.yml for single-VM deployment
# =============================================================
# Usage:
#   docker compose -f docker-compose.django.yml up -d
# =============================================================

services:
  # --- Orthanc (DICOM/PACS Server) ---
  orthanc:
    image: orthancteam/orthanc:latest
    container_name: nn-orthanc
    restart: always
    ports:
      - "8042:8042"   # HTTP Web UI
      - "4242:4242"   # DICOM Protocol
    environment:
      # 인증 완전 비활성화 (외부 접근 허용)
      - ORTHANC__AUTHENTICATION_ENABLED=false
      - ORTHANC__REMOTE_ACCESS_ALLOWED=true
      # HTTP 서버 설정
      - ORTHANC__HTTP_SERVER_HOST=0.0.0.0
      # Authorization 플러그인 완전 비활성화
      - AUTHORIZATION_PLUGIN_ENABLED=false
      - ORTHANC__AUTHORIZATION__ENABLE=false
      - ORTHANC__AUTHORIZATION__CHECK_VIEWERS=false
      # Orthanc Explorer 2 익명 접근 허용
      - ORTHANC__ORTHANC_EXPLORER_2__IS_DEFAULT_ORTHANC_UI=true
      - ORTHANC__ORTHANC_EXPLORER_2__UI__ENABLE_ANONYMOUS_ACCESS=true
    volumes:
      - ./orthanc/orthanc.json:/etc/orthanc/orthanc.json:ro
      - orthanc_data:/var/lib/orthanc/db
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8042/system || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - medical-net

  # --- Redis (Shared Cache/Message Broker) ---
  redis:
    image: redis:7-alpine
    container_name: nn-redis
    restart: always
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - medical-net

  # --- Django Application ---
  django:
    build:
      context: ../brain_tumor_back
      dockerfile: Dockerfile
    image: nn-django:latest
    container_name: nn-django
    restart: always
    depends_on:
      django-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8000:8000"
    environment:
      # Django Settings
      - DJANGO_SETTINGS_MODULE=config.settings
      - DEBUG=${DJANGO_DEBUG:-True}
      - SECRET_KEY=${DJANGO_SECRET_KEY:-your-secret-key}
      - ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS:-*}
      # Database (Django settings.py 환경변수명에 맞춤)
      - MYSQL_HOST=django-db
      - MYSQL_PORT=3306
      - MYSQL_DB=${DJANGO_DB_NAME:-brain_tumor}
      - MYSQL_USER=${DJANGO_DB_USER:-root}
      - MYSQL_PASSWORD=${DJANGO_DB_PASS:-root1234}
      # Redis (Docker 환경에서는 redis 서비스명 사용)
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_URL=redis://redis:6379/0
      # Email
      - EMAIL_HOST_USER=${EMAIL_HOST_USER}
      - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD}
      # External Services (FASTAPI_URL은 반드시 docker/.env에서 설정 필요)
      - FASTAPI_URL=${FASTAPI_URL:-http://localhost:9000}
      - ORTHANC_URL=http://orthanc:8042
      - HAPI_FHIR_URL=http://hapi-fhir:8080
    volumes:
      - ../brain_tumor_back:/app
      - ../CDSS_STORAGE:/CDSS_STORAGE
      - django_static:/app/static
      - django_media:/app/media
    command: >
      sh -c "python manage.py migrate --noinput &&
             python manage.py collectstatic --noinput &&
             daphne -b 0.0.0.0 -p 8000 config.asgi:application"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - medical-net

  # --- Django Database (MySQL) ---
  django-db:
    image: mysql:8.0
    container_name: nn-django-db
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=${DJANGO_DB_ROOT_PASS:-root1234}
      - MYSQL_DATABASE=${DJANGO_DB_NAME:-brain_tumor}
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
    ports:
      - "3306:3306"
    volumes:
      - django_db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DJANGO_DB_ROOT_PASS:-root1234}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - medical-net

networks:
  medical-net:
    name: medical-net
    driver: bridge

volumes:
  orthanc_data:
  redis_data:
  django_db_data:
  django_static:
  django_media:
