# 권한별 앱 재구조화 계획

**작성일**: 2026-01-07
**목표**: 기존 복잡한 앱 구조를 권한별로 재구성하여 단순화

---

## 📊 현재 구조 분석

### 기존 앱 (5개)
1. **emr** - 환자, 진료, 처방 관리
2. **ris** - 영상의학 (DICOM, 판독)
3. **lis** - 검사실 (검사 결과)
4. **ocs** - 마스터 데이터 (약물, 진단)
5. **fhir** - FHIR 동기화

### 유지되는 앱 (4개)
- **accounts** - 사용자 관리
- **authorization** - 인증/권한
- **menus** - 메뉴 관리
- **permissions** - 권한 관리
- **audit** - 감사 로그
- **common** - 공통 유틸리티

---

## 🎯 새로운 권한별 앱 구조

### 핵심 개념
- **역할 중심 설계**: 각 사용자 역할별로 필요한 기능을 하나의 앱으로 그룹화
- **단순화**: 복잡한 앱 간 의존성 제거
- **명확한 책임**: 각 앱은 특정 사용자 그룹의 워크플로우 담당

---

## 📁 새로운 앱 구조

```
brain_tumor_back/apps/
├── accounts/           # [유지] 사용자 관리
├── authorization/      # [유지] 인증/권한
├── menus/             # [유지] 메뉴 관리
├── permissions/       # [유지] 권한 관리
├── audit/             # [유지] 감사 로그
├── common/            # [유지] 공통 유틸리티
│
├── doctor/            # [신규] 의사용 앱
├── nurse/             # [신규] 간호사용 앱
├── patient/           # [신규] 환자용 앱
├── radiologist/       # [신규] 영상의학과 의사용 앱
├── lab_tech/          # [신규] 검사실 기사용 앱
├── admin_clinical/    # [신규] 관리자용 앱
└── external/          # [신규] 외부 기관 연동용 앱
```

---

## 🔄 앱별 상세 설계

### 1. doctor (의사용 앱)
**역할**: 진료, 처방, 진단을 담당하는 의사
**기능**:
- 환자 조회 및 진료 기록 작성
- 처방 발행 (약물, 검사, 영상)
- 진단 코드 입력
- 검사 결과 조회
- 영상 조회 (기본 뷰어)

**모델** (기존 모델 이동):
- `PatientCache` (from emr) - 환자 정보 캐시
- `Encounter` (from emr) - 진료 기록
- `EncounterDiagnosis` (from emr) - 진단 내역
- `Order` (from emr) - 처방 주문
- `OrderItem` (from emr) - 처방 항목

**API 엔드포인트**:
```
GET    /api/doctor/patients/              # 환자 목록
GET    /api/doctor/patients/{id}/         # 환자 상세
POST   /api/doctor/encounters/            # 진료 기록 작성
GET    /api/doctor/encounters/{id}/       # 진료 기록 조회
POST   /api/doctor/orders/                # 처방 발행
GET    /api/doctor/orders/                # 처방 목록
GET    /api/doctor/lab-results/           # 검사 결과 조회
GET    /api/doctor/imaging-studies/       # 영상 목록
```

---

### 2. nurse (간호사용 앱)
**역할**: 환자 등록, 바이탈 체크, 처방 실행
**기능**:
- 환자 등록/수정
- 바이탈 사인 입력
- 처방 실행 확인 (약물 투여 기록)
- 검사 샘플 채취 기록

**모델**:
- `PatientVitals` (신규) - 바이탈 사인
- `MedicationAdministration` (신규) - 약물 투여 기록
- 기존 `PatientCache`, `Order` 참조 (읽기 전용)

**API 엔드포인트**:
```
POST   /api/nurse/patients/               # 환자 등록
PUT    /api/nurse/patients/{id}/          # 환자 정보 수정
POST   /api/nurse/vitals/                 # 바이탈 사인 입력
POST   /api/nurse/medication-admin/       # 약물 투여 기록
GET    /api/nurse/orders/pending/         # 대기 중인 처방
```

---

### 3. patient (환자용 앱)
**역할**: 환자 본인의 의료 정보 조회
**기능**:
- 본인 진료 기록 조회
- 처방 내역 조회
- 검사 결과 조회 (공개 가능한 것만)
- 예약 조회

**모델**:
- 기존 모델 참조 (읽기 전용)
- `PatientAppointment` (신규) - 예약 정보

**API 엔드포인트**:
```
GET    /api/patient/me/                   # 내 정보
GET    /api/patient/encounters/           # 내 진료 기록
GET    /api/patient/prescriptions/        # 내 처방 내역
GET    /api/patient/lab-results/          # 내 검사 결과 (공개)
GET    /api/patient/appointments/         # 내 예약
```

---

### 4. radiologist (영상의학과 의사용 앱)
**역할**: 영상 검사 판독
**기능**:
- 영상 검사 워크리스트 조회
- DICOM 영상 뷰어 (Orthanc 연동)
- 판독문 작성
- 검사 완료 처리

**모델** (기존 RIS 모델 이동):
- `RadiologyOrder` (from ris)
- `RadiologyStudy` (from ris)
- `RadiologyReport` (from ris)

**API 엔드포인트**:
```
GET    /api/radiologist/worklist/         # 판독 대기 목록
GET    /api/radiologist/studies/{id}/     # DICOM 영상 조회
POST   /api/radiologist/reports/          # 판독문 작성
PUT    /api/radiologist/reports/{id}/     # 판독문 수정
POST   /api/radiologist/reports/{id}/sign/ # 판독문 서명
```

---

### 5. lab_tech (검사실 기사용 앱)
**역할**: 검사 실행 및 결과 입력
**기능**:
- 검사 오더 조회 (워크리스트)
- 검사 결과 입력
- 검사 완료 처리

**모델** (기존 LIS 모델 이동):
- `LabTestMaster` (from lis)
- `LabResult` (from lis)

**API 엔드포인트**:
```
GET    /api/lab-tech/worklist/            # 검사 대기 목록
POST   /api/lab-tech/results/             # 검사 결과 입력
PUT    /api/lab-tech/results/{id}/        # 검사 결과 수정
POST   /api/lab-tech/results/{id}/verify/ # 검사 결과 확인
```

---

### 6. admin_clinical (관리자용 앱)
**역할**: 시스템 관리 및 마스터 데이터 관리
**기능**:
- 마스터 데이터 관리 (약물, 진단, 검사)
- 시스템 설정
- 통계 조회
- 감사 로그 조회

**모델** (기존 OCS 모델 이동):
- `MedicationMaster` (from ocs)
- `DiagnosisMaster` (from ocs)
- `LabTestMaster` 참조

**API 엔드포인트**:
```
GET    /api/admin/medications/            # 약물 마스터 목록
POST   /api/admin/medications/            # 약물 마스터 등록
GET    /api/admin/diagnoses/              # 진단 마스터 목록
POST   /api/admin/diagnoses/              # 진단 마스터 등록
GET    /api/admin/lab-tests/              # 검사 마스터 목록
GET    /api/admin/statistics/             # 통계
GET    /api/admin/audit-logs/             # 감사 로그
```

---

### 7. external (외부 기관 연동용 앱)
**역할**: FHIR, OpenEMR 등 외부 시스템 연동
**기능**:
- FHIR 리소스 변환 및 동기화
- OpenEMR 동기화
- 외부 API 통합

**모델** (기존 FHIR 모델 + EMR SyncOutbox 이동):
- `FHIRResourceMap` (from fhir)
- `FHIRSyncQueue` (from fhir)
- `SyncOutbox` (from emr)

**API 엔드포인트**:
```
POST   /api/external/fhir/sync/           # FHIR 동기화 트리거
GET    /api/external/fhir/status/         # 동기화 상태
GET    /api/external/fhir/Patient/{id}/   # FHIR Patient 리소스
POST   /api/external/openemr/sync/        # OpenEMR 동기화
```

---

## 🔗 앱 간 관계 및 공유 데이터

### 공유 모델 (common 앱으로 이동 고려)
다음 모델들은 여러 앱에서 참조되므로 `common` 앱으로 이동:
- `PatientCache` → `common.Patient`
- `Encounter` → `common.Encounter`
- `Order` → `common.Order`
- `OrderItem` → `common.OrderItem`

### 앱 간 의존성
```
doctor → common (Patient, Encounter, Order)
nurse → common (Patient, Order)
radiologist → common (Patient, Order - 영상 오더)
lab_tech → common (Patient, Order - 검사 오더)
patient → common (읽기 전용)
admin_clinical → 모든 앱 (마스터 데이터)
external → 모든 앱 (동기화)
```

---

## 📝 마이그레이션 계획

### Phase 1: 공통 모델 분리
1. `common` 앱에 공유 모델 이동
2. 기존 앱에서 common import로 변경

### Phase 2: 권한별 앱 생성
1. 새로운 7개 앱 생성 (doctor, nurse, patient, radiologist, lab_tech, admin_clinical, external)
2. 각 앱에 `models.py`, `views.py`, `serializers.py`, `urls.py` 생성

### Phase 3: 모델 마이그레이션
1. 기존 모델을 새 앱으로 이동 (db_table 유지)
2. 마이그레이션 생성 및 적용

### Phase 4: 뷰 및 API 재구성
1. 기존 뷰를 권한별 앱으로 분산
2. URL 패턴 재구성
3. 권한 체크 로직 추가

### Phase 5: 테스트 및 검증
1. API 엔드포인트 테스트
2. 권한 테스트
3. 프론트엔드 연동 테스트

---

## ⚠️ 주의사항

1. **DB 테이블명 유지**: 기존 데이터 보존을 위해 `db_table` 속성 유지
2. **하위 호환성**: 기존 API 엔드포인트는 deprecated로 표시 후 점진적 제거
3. **권한 체크**: 각 앱의 뷰에 적절한 권한 데코레이터 추가
4. **로그인 시스템 유지**: `accounts`, `authorization` 앱은 절대 변경하지 않음
5. **점진적 마이그레이션**: 한 번에 모든 앱을 변경하지 않고 단계적으로 진행

---

## 🎯 기대 효과

1. **명확한 책임 분리**: 각 앱이 특정 사용자 역할의 워크플로우만 담당
2. **유지보수 용이**: 역할별로 코드가 분리되어 수정 범위가 명확
3. **보안 강화**: 권한별 앱 분리로 접근 제어가 명확
4. **개발 효율성**: 새로운 기능 추가 시 해당 역할 앱만 수정
5. **코드 가독성**: 복잡한 앱 간 의존성 제거로 코드 이해 용이

---

## 📌 다음 단계

사용자 승인 후:
1. Phase 1 시작: common 앱에 공통 모델 분리
2. 새로운 앱 구조 생성
3. 점진적 마이그레이션 실행
